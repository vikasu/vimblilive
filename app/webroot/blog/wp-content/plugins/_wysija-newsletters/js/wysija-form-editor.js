Object.extend(Prototype.Browser,{ie6:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===6?true:false):false,ie7:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===7?true:false):false,ie8:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===8?true:false):false,ie9:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===9?true:false):false});Event.cacheDelegated={};Object.extend(document,(function(){var b=Event.cacheDelegated;function d(g){return b[g]=b[g]||{}}function a(g,h){var i=d(g);return i[h]=i[h]||[]}function c(g,h,i){var j=a(g,h);return j.find(function(k){return k.handler===i})}function f(g,h,i){var k=d(g);if(!k[h]){return false}var j=c(g,h,i);k[h]=k[h].without(j);return j}function e(g,h,j,i){var l,k=a(g,h);if(k.pluck("handler").include(j)){return false}l=function(n){var m=n.findElement(g);if(m){j.call(i||m,n,m)}};l.handler=j;k.push(l);return l}return{delegate:function(g,h,j,i){var k=e.apply(null,arguments);if(k){document.observe(h,k)}return document},stopDelegating:function(g,i,j){var h=arguments.length;switch(h){case 2:a(g,i).each(function(l){document.stopDelegating(g,i,l.handler)});break;case 1:Object.keys(d(g)).each(function(l){document.stopDelegating(g,l)});break;case 0:Object.keys(b).each(function(l){document.stopDelegating(l)});break;default:var k=f.apply(null,arguments);if(k){document.stopObserving(i,k)}}return document}}})());var Observable=(function(){function d(e,f){e=e.substring(2);if(f){e=f+":"+e}return e.underscore().split("_").join(":")}function b(e){var g=e.prototype,f=g.namespace;return Object.keys(g).grep(/^on/).inject($H(),function(h,i){if(i==="onDomLoaded"){return h}h.set(d(i,f),a(g[i],e));return h})}function a(f,e){return function(g){return f.call(new e(this),g,g.memo)}}function c(f,e){$$(f).each(function(g){new e(g).onDomLoaded()})}return{observe:function(f){if(!this.handlers){this.handlers={}}if(this.handlers[f]){return}var e=this;if(this.prototype.onDomLoaded){document.loaded?c(f,e):document.observe("dom:loaded",c.curry(f,e))}this.handlers[f]=b(e).each(function(g){document.delegate(f,g.key,g.value)})},stopObserving:function(e){if(!this.handlers||!this.handlers[e]){return}this.handlers[e].each(function(f){document.stopDelegating(e,f.key,f.value)});delete this.handlers[e]}}})();Object.extend(Droppables,{deactivate:Droppables.deactivate.wrap(function(a,b,c){if(b.onLeave){b.onLeave(c,b.element)}return a(b)}),activate:Droppables.activate.wrap(function(a,b,c){if(b.onEnter){b.onEnter(c,b.element)}return a(b)}),show:function(a,c){if(!this.drops.length){return}var b,d=[];this.drops.each(function(e){if(Droppables.isAffected(a,c,e)){d.push(e)}});if(d.length>0){b=Droppables.findDeepestChild(d)}if(this.last_active&&this.last_active!==b){this.deactivate(this.last_active,c)}if(b){Position.within(b.element,a[0],a[1]);if(b.onHover){b.onHover(c,b.element,Position.overlap(b.overlap,b.element))}if(b!==this.last_active){Droppables.activate(b,c)}}},displayArea:function(a){if(!this.drops.length){return}WysijaForm.hideBlockControls();this.drops.each(function(b,c){if(b.element.hasClassName("block_placeholder")){b.element.resizeHeight(30);b.element.addClassName("active")}})},hideArea:function(){if(!this.drops.length){return}this.drops.each(function(a,b){if(a.element.hasClassName("block_placeholder")){a.element.resizeHeight(0);a.element.removeClassName("active")}else{if(a.element.hasClassName("image_placeholder")){a.element.removeClassName("active");a.element.up().removeClassName("active")}else{if(a.element.hasClassName("text_placeholder")){a.element.removeClassName("active")}}}})},reset:function(a){if(this.last_active){this.deactivate(this.last_active,a)}}});Element.addMethods({resizeHeight:function(b,d,c,a){return new Effect.Morph(b,{style:{height:parseInt(d)+"px"},afterUpdate:c,afterFinish:a,duration:0.1})},scrollToCenter:function(a,b){var a=$(a);var c=Object.extend({duration:0.2,offset:-document.viewport.getHeight()/2},b||{});Effect.ScrollTo(a,c);return a}});var WysijaForm={version:"0.1",options:{container:"wysija_form_editor",body:"wysija_form_editor",debug:false,css:"wj_css",toolbar:"wysija_form_toolbar",wrapper:"wysija_form_editor"},toolbar:{effect:null,x:null,y:null,top:null,left:null},scroll:{top:0,left:0},locks:{dragging:false,selectingColor:false,showingTools:false},defaults:{},init:function(){info("init -> set scroll offsets");WysijaForm.setScrollOffsets();info("init -> make droppable");WysijaForm.makeDroppable();info("init -> make sortable");WysijaForm.makeSortable();info("init -> hide controls");WysijaForm.hideControls();info("init -> hide settings");WysijaForm.hideSettings();info("init -> init toolbar & settings");WysijaForm.initToolbar();WysijaForm.setSettingsPosition();info("init -> set toolbar position");WysijaForm.setToolbarPosition();info("init -> toggle widgets");WysijaForm.toggleWidgets()},toggleWidgets:function(){var b=$$('a[wysija_unique="1"]').collect(function(c){return $(c).identify()}),a=null;$$('a[wysija_unique="1"]').invoke("removeClassName","disabled");WysijaForm.getBlocks().each(function(c){if(c.block===undefined){return $continue}a=c.block.element.readAttribute("wysija_field");if($$("a#"+a+'[wysija_unique="1"]').length===1){$$("a#"+a+'[wysija_unique="1"]')[0].addClassName("disabled")}})},setBlockPositions:function(d,e){WysijaForm.locks.dragging=false;var a=1;WysijaForm.getBlocks().each(function(f){f.setPosition(a++);if(f.block!==undefined){f.block.element.setStyle({zIndex:""})}});if(e!==undefined){var b=$(e.element.readAttribute("wysija_placeholder")),c=e.element.previous(".block_placeholder");if(b!==null){e.element.insert({before:b});if(e.element.next()!==undefined&&e.element.next().hasClassName("wysija_form_block")&&c!==undefined){e.element.insert({after:c})}}}},setScrollOffsets:function(){WysijaForm.scroll=document.viewport.getScrollOffsets()},hideSettings:function(){$(WysijaForm.options.container).select(".wysija_settings").invoke("hide")},setSettingsPosition:function(){var a=document.viewport.getHeight(),b=5;$(WysijaForm.options.container).select(".wysija_settings").each(function(i){var g=i;try{var h=i.up(".wysija_form_block").getDimensions(),l=i.up(".wysija_form_block").cumulativeOffset(),m=(l.top<=(WysijaForm.scroll.top+a))?true:false,d=5,f=d}catch(i){console.log(g)}if(m){var c=WysijaForm.scroll.top+((a/2)-(i.getHeight()/2)),k=parseInt(l.top-b),j=parseInt(l.top+h.height-b);if(parseInt(h.height)<200){f=parseInt((h.height/2)-(i.getHeight()/2))}else{if((c+d)>(j+b)){f=parseInt(h.height-d)}else{if((c-d)<(k+b)){f=d}else{f=parseInt(c-l.top)}}}}new Effect.Move(i,{x:parseInt((h.width/2)-(i.getWidth()/2)),y:f,mode:"absolute",duration:0.2})})},initToolbar:function(){Event.stopObserving("scroll");Event.observe(window,"scroll",function(){WysijaForm.setScrollOffsets();WysijaForm.setSettingsPosition();WysijaForm.updateToolbarPosition()})},initToolbarPosition:function(){if(WysijaForm.toolbar.top===null){WysijaForm.toolbar.top=parseInt($(WysijaForm.options.wrapper).positionedOffset().top)}if(WysijaForm.toolbar.left===null){WysijaForm.toolbar.left=parseInt($(WysijaForm.options.wrapper).positionedOffset().left)}if(WysijaForm.toolbar.x===null){WysijaForm.toolbar.x=parseInt(WysijaForm.toolbar.left+$(WysijaForm.options.wrapper).getDimensions().width+15)}if(WysijaForm.scroll.top>=(WysijaForm.toolbar.top-20)){WysijaForm.toolbar.y=parseInt(20+WysijaForm.scroll.top)}else{WysijaForm.toolbar.y=parseInt(WysijaForm.toolbar.top+WysijaForm.scroll.top)}},setToolbarPosition:function(){WysijaForm.initToolbarPosition();$(WysijaForm.options.toolbar).setStyle({top:WysijaForm.toolbar.y+"px",left:WysijaForm.toolbar.x+"px",opacity:0}).fade({duration:1,from:0,to:1})},updateToolbarPosition:function(){WysijaForm.initToolbarPosition();if(WysijaForm.toolbar.effect!==null){WysijaForm.toolbar.effect.cancel()}if(WysijaForm.scroll.top>=(WysijaForm.toolbar.top-20)){WysijaForm.toolbar.y=parseInt(20+WysijaForm.scroll.top);WysijaForm.toolbar.effect=new Effect.Move(WysijaForm.options.toolbar,{x:WysijaForm.toolbar.x,y:WysijaForm.toolbar.y,mode:"absolute",duration:0.2})}else{$(WysijaForm.options.toolbar).setStyle({left:WysijaForm.toolbar.x+"px",top:WysijaForm.toolbar.top+"px"})}},blockDropOptions:{accept:$w("wysija_form_item"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(b,c){var a={};a.type=b.readAttribute("wysija_type");a.field=b.readAttribute("wysija_field");a.label=b.readAttribute("wysija_label");a.element=b;c.fire("wjfe:item:drop",a);$(c).removeClassName("hover")}},hideControls:function(){try{return WysijaForm.getBlocks().invoke("hideControls")}catch(a){}},hideTools:function(){$$(".wysija_tools").invoke("hide");WysijaForm.locks.showingTools=false},hideSettings:function(){$(WysijaForm.options.container).select(".wysija_settings").invoke("hide")},instances:{},fields:{},get:function(b,c){if(c===undefined){c="block"}var d=b.identify();var a=WysijaForm.instances[d]||new WysijaForm[c.capitalize().camelize()](d);WysijaForm.instances[d]=a;return a},makeDroppable:function(){Droppables.add("block_placeholder",WysijaForm.blockDropOptions)},makeSortable:function(){var a=$(WysijaForm.options.body);Sortable.create(a,{tag:"div",only:"wysija_form_block",scroll:window,handle:"handle",constraint:"vertical"});Draggables.removeObserver(a);Draggables.addObserver({element:a,onStart:WysijaForm.startBlockPositions,onEnd:WysijaForm.setBlockPositions})},hideBlockControls:function(){$$(".wysija_controls").invoke("hide");this.getBlockElements().invoke("removeClassName","hover")},getBlocks:function(){return WysijaForm.getBlockElements().map(function(a){return WysijaForm.get(a)})},getBlockElements:function(){return $$("div.wysija_form_block")},startBlockPositions:function(a,b){if(b.element.hasClassName("wysija_form_block")){if(b.element.previous(".block_placeholder")!==undefined){b.element.writeAttribute("wysija_placeholder",b.element.previous(".block_placeholder").identify())}}WysijaForm.locks.dragging=true}};WysijaForm.DraggableItem=Class.create({initialize:function(a){this.elementType=$(a).readAttribute("wysija_type");this.element=$(a).down()||$(a);this.clone=this.cloneElement();this.insert()},STYLES:new Template("position: absolute; top: #{top}px; left: #{left}px;"),cloneElement:function(){var d=this.element.clone(),c=this.element.cumulativeOffset(),b=this.getList(),a=this.STYLES.evaluate({top:c.top-b.scrollTop,left:c.left-b.scrollLeft});d.setStyle(a);d.addClassName("wysija_form_widget");d.addClassName(this.elementType);d.innerHTML=this.element.innerHTML;return d},getOffset:function(){return this.element.offsetTop-this.getList().scrollTop},getList:function(){return this.element.up("ul")},insert:function(){$$("body")[0].insert(this.clone)},onMousedown:function(a){var b=new Draggable(this.clone,{scroll:window,onStart:function(){Droppables.displayArea(b)},onEnd:function(c){c.destroy();c.element.remove();Droppables.hideArea()},starteffect:function(c){new Effect.Opacity(c,{duration:0.2,from:c.getOpacity(),to:0.7})},endeffect:Prototype.emptyFunction});b.initDrag(a);b.startDrag(a);return b}});Object.extend(WysijaForm.DraggableItem,Observable).observe('a[class="wysija_form_item"]');WysijaForm.Block=Class.create({initialize:function(a){info("block -> init");this.element=$(a);this.elementType=this.element.readAttribute("wysija_type");if(WysijaForm[this.elementType.capitalize().camelize()]===undefined){console.log('"'+this.elementType.capitalize().camelize()+'" widget does not exist')}else{this.block=new WysijaForm[this.elementType.capitalize().camelize()](this.element);if(parseInt(this.element.readAttribute("wysija_new"))===1){this.block.draw();this.element.writeAttribute("wysija_new",0)}this.block.makeBlockDroppable();if(this.block.setup!==undefined){this.block.setup()}}return this},draw:function(){console.log(this.element)},getCustomData:function(a){if(this.element.down(".wysija_options."+a)!==undefined){info("got options for "+a);return this.element.down(".wysija_options."+a).innerHTML.toQueryParams("&amp;")}else{info("no options to get for "+a);return null}},getOptions:function(){return this.options},setOptions:function(a){if(a===undefined){a={}}if(this.options===undefined){this.options=new Hash()}this.options=this.options.update(a);return this},setPosition:function(a){this.element.writeAttribute("wysija_position",a)},hideControls:function(){if(this["getControls"]){this.element.removeClassName("hover");this.getControls().hide()}},showControls:function(){if(this["getControls"]){this.element.addClassName("hover");try{this.getControls().show()}catch(a){console.log(this["getControls"])}}},makeBlockDroppable:function(){if(this.isBlockDroppableEnabled()===false){var a=this.getBlockDroppable();Droppables.add(a.identify(),WysijaForm.blockDropOptions);a.addClassName("enabled")}},removeBlockDroppable:function(){if(this.isBlockDroppableEnabled()){var a=this.getBlockDroppable();Droppables.remove(a.identify());a.removeClassName("enabled")}},isBlockDroppableEnabled:function(){var a=this.getBlockDroppable();if(a===null){return this.createBlockDroppable().hasClassName("enabled")}else{return a.hasClassName("enabled")}},createBlockDroppable:function(){info("block -> createBlockDroppable");this.element.insert({before:'<div class="block_placeholder"></div>'});return this.element.previous(".block_placeholder")},getBlockDroppable:function(){if(this.element.previous()===undefined||this.element.previous().hasClassName("block_placeholder")===false){return null}else{return this.element.previous()}},getControls:function(){return this.element.down(".wysija_controls")},setupControls:function(){this.controls=this.getControls();if(this.controls){this.element.observe("mouseover",function(){if(WysijaForm.locks.dragging===true||WysijaForm.locks.selectingColor===true||WysijaForm.locks.showingTools===true){return}this.element.addClassName("hover");this.showControls();if(this.element.down(".wysija_settings")!==undefined){this.element.down(".wysija_settings").show()}}.bind(this));this.element.observe("mouseout",function(){if(WysijaForm.locks.dragging===true||WysijaForm.locks.selectingColor===true){return}this.hideControls();if(this.element.down(".wysija_settings")!==undefined){this.element.down(".wysija_settings").hide()}}.bind(this));if(this.element.hasClassName("static")===false){this.removeButton=this.controls.down(".remove");this.removeButton.observe("click",function(){this.removeBlock();this.removeButton.stopObserving("click")}.bind(this));this.settingsButton=this.element.down(".settings");this.settingsButton.observe("click",function(){this.editSettings()}.bind(this))}}return this},setBackgroundColor:function(b){if(b!==undefined){this.element.writeAttribute("wysija_bg_color",b)}var a=this.element.readAttribute("wysija_bg_color");if(a===""){this.element.setStyle({backgroundColor:"transparent"})}else{if(a!==null){this.element.setStyle({backgroundColor:"#"+a})}}WysijaForm.autoSave()},removeBlock:function(a){info("block -> removeBlock");delete WysijaForm.instances[this.element.identify()];this.element.blindUp({duration:0.2,afterFinish:function(b){if(b.element.next(".wysija_form_block")!==undefined&&a!==false){WysijaForm.get(b.element.next(".wysija_form_block")).block.showControls()}if(b.element.previous(".block_placeholder")!==undefined){b.element.previous(".block_placeholder").remove()}b.element.remove();WysijaForm.setBlockPositions();WysijaForm.toggleWidgets();if(a!==undefined&&typeof(a)==="function"){a()}}})},setFocus:function(){this.element.scrollToCenter()}});WysijaForm.Block.create=function(c,e){var d,a=$(WysijaForm.options.body),b=new Template('<div class="wysija_form_block" wysija_type="#{type}" wysija_field="#{field}" wysija_new="1">'+'<span class="wysija_options">#{options}</span>'.interpolate({options:Object.toQueryString(c)})+$$('.wysija_form_template[wysija_type="'+c.type+'"][wysija_field="'+c.field+'"]')[0].innerHTML+"</div>");if(e.identify()==="block_placeholder"){a.insert(b.evaluate(c));d=a.childElements().last()}else{e.insert({before:b.evaluate(c)});d=e.previous(".wysija_form_block")}WysijaForm.makeSortable();WysijaForm.setBlockPositions()};document.observe("wjfe:item:drop",function(a){info("create block");WysijaForm.Block.create(a.memo,a.target);info("hide controls");WysijaForm.hideBlockControls()});WysijaForm.Input=Class.create(WysijaForm.Block,{initialize:function(a){info("input -> init");this.element=$(a);return this},setup:function(){info("input -> setup");this.setupControls()},save:function(){info("input -> save");var a={};this.getParameters();a.params=this.params;return a},getParameters:function(){info("input -> get parameters");this.params=[];var a=this.element.down(".wysija_params");if(a!==undefined){a.select("input").each(function(b){this.params.push($H({key:b.name,value:b.value}))}.bind(this))}return this},getControls:function(){return this.element.down(".wysija_controls")},editSettings:function(){this.getParameters();var a=this.formatParameters();WysijaPopup.open(Wysija_i18n.autoPostSettingsTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=input&"+a,this.callback.bind(this))},callback:function(a){this.element.replace(Base64.decode(a));WysijaForm.init()},formatParameters:function(){var a=["input_count="+$$(".wysija_auto-post").length,"input_type="+$("wysija_widgets_settings").down(".input").innerHTML];if(this.params!==undefined&&this.params.length>0){this.params.each(function(b){a.push(b.get("key")+"="+b.get("value"))});a=a.join("&")}return a},remove:function(){info("input remove");this.removeBlock()},getSettings:function(){return this.element.down(".wysija_settings")}});WysijaForm.Submit=Class.create(WysijaForm.Block,{initialize:function(a){info("submit -> init");this.element=$(a);return this},setup:function(){info("submit -> setup");this.setupControls()},save:function(){info("submit -> save");var a={};this.getParameters();a.params=this.params;return a},getParameters:function(){info("submit -> get parameters");this.params=[];var a=this.element.down(".wysija_params");if(a!==undefined){a.select("submit").each(function(b){this.params.push($H({key:b.name,value:b.value}))}.bind(this))}return this},editSettings:function(){this.getParameters();var a=this.formatParameters();WysijaPopup.open(Wysija_i18n.autoPostSettingsTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=submit&"+a,this.callback.bind(this))},callback:function(a){this.element.replace(Base64.decode(a));WysijaForm.init()},remove:function(){info("submit remove");this.removeBlock(function(){})},getSettings:function(){return this.element.down(".wysija_settings")}});document.observe("dom:loaded",WysijaForm.init);function info(a){if(WysijaForm.options.debug===false){return}if(!(window.console&&console.log)){(function(){var f=function(){};var e=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","markTimeline","table","time","timeEnd","timeStamp","trace","warn"];var c=e.length;var d=window.console={};while(c--){d[e[c]]=f}}())}try{console.log("[INFO] "+a)}catch(b){}};